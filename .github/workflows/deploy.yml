# Имя флоу
name: Deploy on server hw15

# Когда действие запустится (триггеры)
on:
  push:
    # при push в main
    branches: [ main ]

  pull_request:
    # при создании pull request на main
    branches: [ main ]

# Что будем делать (экшены)
jobs:
  # Имя действия, придумываем сами
  integration-tests:
    # На какой ОС будет работать виртуальная машина
    # Можно выбрать Ubuntu, Windows Server или macOS
    runs-on: ubuntu-latest
    # Шаги действия
    steps:
      # Шаг 1: собираем сервисы в режиме тестирования
      - uses: actions/checkout@v2
      - name: Build the stack
        run: docker-compose -f docker-compose.yaml up -d --build
#        run: docker-compose -f docker-compose.prod.yml -f docker-compose.test.yml up -d --build

      # Шаг 2: собираем проект с тестами
      - name: Build tests
        run: echo 'test'
#        run: dotnet build GOT.Tests
#
#      # Шаг 3: запускаем тесты с небольшой детализацией
#      - name: Run tests
#        run: dotnet test LOT.Tests --verbosity normal
      - name: "Run deploy on server"
        uses: appleboy/ssh-action@main
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
#        run: docker-compose -f docker-compose.yaml up -d --build
#          script: |
#            sudo docker-compose -f docker-compose.prod-ci.yml -p prod pull
#            sudo docker-compose -f docker-compose.prod-ci.yml -p prod up -d